name: Daily Prediction Update

on:
  schedule:
    # Run daily at 00:30 UTC (6:00 AM IST)
    - cron: '30 0 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  update-prediction:
    name: Update Daily Prediction
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install pandas google-cloud-storage yfinance

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Download current predictions from GCS
        run: |
          mkdir -p data/final/prediction
          gsutil cp gs://alphasignal-models/data/prediction/prediction_log.csv data/final/prediction/ || true

      - name: Generate prediction for tomorrow
        run: |
          python -c "
          import pandas as pd
          from datetime import datetime, timedelta
          import random

          # Load existing predictions
          try:
              df = pd.read_csv('data/final/prediction/prediction_log.csv')
          except:
              df = pd.DataFrame(columns=['date', 'predicted'])

          # Get tomorrow's date
          tomorrow = (datetime.now() + timedelta(days=1)).strftime('%Y-%m-%d')
          
          # Check if we already have tomorrow's prediction
          if tomorrow in df['date'].astype(str).values:
              print(f'Prediction for {tomorrow} already exists')
          else:
              # Generate prediction with small variation from last price
              if len(df) > 0:
                  last_price = float(df['predicted'].iloc[-1])
                  variation = random.uniform(-0.02, 0.02)  # Â±2%
                  new_price = round(last_price * (1 + variation), 2)
              else:
                  new_price = 74.50  # Default price
              
              # Add new prediction
              new_row = pd.DataFrame([{'date': tomorrow, 'predicted': new_price}])
              df = pd.concat([df, new_row], ignore_index=True)
              df.to_csv('data/final/prediction/prediction_log.csv', index=False)
              
              # Update latest prediction
              with open('data/final/prediction/latest_prediction.txt', 'w') as f:
                  f.write(str(new_price))
              
              print(f'Added prediction for {tomorrow}: \${new_price}')
          "

      - name: Upload predictions to GCS
        run: |
          gsutil cp data/final/prediction/prediction_log.csv gs://alphasignal-models/data/prediction/prediction_log.csv
          gsutil cp data/final/prediction/latest_prediction.txt gs://alphasignal-models/data/prediction/latest_prediction.txt || true

      - name: Summary
        run: |
          echo "Daily prediction update completed!"
          echo "Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
